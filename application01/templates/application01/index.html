<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地铁车站查询</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        .left-panel {
            flex-basis: 17.5%;
        }

        .middle-panel {
            flex-basis: 55%;
        }

        .right-panel {
            flex-basis: 17.5%;
        }

        /* 线路图按钮 */
        .line-map-button {
            height: 30px;
            width: 100%;
        }

        /* 计算路线按钮 */
        .path-calculate-button {
            height: 30px;
            width: 100%;
        }

        /* 路径输入框-标签 */
        .path-input-label {
            font-size: 0.9em;
        }

        /* 线路图标 */
        .color-circle {
            display: inline-block;
            width: 25px;  /* 圆环直径 */
            height: 25px; /* 圆环直径 */
            border-radius: 50%; /* 使div成为圆形 */
            margin-right: 8px;  /* 与线路名称之间的间距 */
            margin-top: -4px;/* 对齐文字 */
            vertical-align: middle; /* 垂直居中对齐 */
            border: 2px solid; /* 添加边框以形成圆环效果 */
            box-sizing: border-box; /* 确保边框包含在宽度和高度内 */
            position: relative; /* 使内部的数字可以绝对定位 */
            background-color: white; /* 背景颜色 */
            z-index: 2;
        }

        .color-circle span {
            position: absolute;
            top: 52%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px; /* 调整字体大小 */
            color: black; /* 文字颜色 */
            line-height: 2; /* 确保文字垂直居中 */
            z-index: 2;
        }

        /* 线路列表项 */
        .line-item {
            display: flex;
            align-items: center; /* 垂直居中对齐 */
        }

        /* 线路列表项-终点站列表项 */
        .end-stations {
            font-size: 0.75rem; /* 使字体变小 */
            margin-left: 10px; /* 与线路名称之间的间距 */
        }

        /* 车站列表 */
        .station-list {
            display: flex;
            flex-direction: column; /* 列方向排列 */
            list-style: none; /* 移除默认的列表样式 */
            padding: 0; /* 移除默认的内边距 */
            margin: 0; /* 移除默认的外边距 */
            height: 100%; /* 确保 ul 有明确的高度 */
        }

        /* 车站列表项-站名字段 */
        .station-name {
            font-size: 16px;
            padding-right: 12px;
            text-align: right; /* 文本右对齐 */
            width: 16%;
        }

        /* 车站列表项-线路与设施图标 */
        .station-icons {
            display: flex;
            align-items: center;
            width: 25%
        }

        /* 车站列表项-竖条样式 */
        .line-bar-up {
            position: absolute;
            bottom: 50%;
            left: 27%;
            width: 8px;
            z-index: 1;
        }
        .line-bar-down {
            position: absolute;
            top: 50%;
            left: 27%;
            width: 8px;
            z-index: 1;
        }

        /* 车站列表项-首班车信息 */
        .first-train {
            display: flex;
            align-items: center;
            width: 30%;

        }

        /* 车站列表项-末班车信息 */
        .last-train {
            display: flex;
            align-items: center;
            width: 30%;

        }

        /* 车站列表项-首末班车文本*/
        .train-label {
            padding-right: -5px;
            font-size: 0.88em;

        }

        .train-direction {
            width: 40%;
        }

        .train-time {
            width: 35%;
        }

        /* 车站列表项-首末班车列表项 */
        .train-direction-data {
            padding-right: 5px;
            text-align: right;
            flex: 1;
            font-size: 0.5em;
            color: #333;
        }

        .train-time-data {
            margin-top: 2px;/* 对齐文字 */
            font-size: 0.77em;
            width: 40%;
            color: #222;
        }

        /* 车站列表项-更多功能按钮 */
        .station-options-button {
            background-color: #fff;
            border: 2px solid #999;
            color: #777; /* 文字颜色 */
            font-weight: bold; /* 文字加粗 */
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto; /* 将按钮推到右侧 */
        }

        .station-options-button:hover {
            background-color: #bbb;
        }

        /* 车站列表项-更多功能按钮-子功能列表 */
        .station-options-popup {
            background-color: white; /* 或者其他颜色 */
            border: 1px solid #ccc;
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .station-options-popup li {
            padding: 4px 8px;
            cursor: pointer;
        }

        /* 路径列表 */
        .path-list {
            display: flex;
            flex-direction: column; /* 列方向排列 */
            list-style: none; /* 移除默认的列表样式 */
            padding: 0; /* 移除默认的内边距 */
            margin: 0; /* 移除默认的外边距 */
            height: 100%; /* 确保 ul 有明确的高度 */
        }

        /* 路径列表-路径信息列表 */
        .path-info {
            display: flex; /* 水平排布 */
            justify-content: flex-start; /* 子元素靠左对齐 */
            align-items: center; /* 垂直居中对齐 */
        }

        /* 路径列表-路径信息项 */
        .path-info-item {
            padding: 5px;
            margin-right: 10px;
            text-align: left; /* 文本左对齐 */
            font-size: 0.8em;
        }

    </style>
</head>
<body>
    <header>
        <h1>地铁车站查询</h1>
    </header>
    <main>
        <div class="container">
            <div class="panel left-panel" style="width: 20%;">
                <button type="button" class="line-map-button">显示线路图</button>
                <ul id="line-list">
                    {% for line in lines %}
                        <li>
                            <a href="#" data-line-no="{{ line.line_no }}" class="line-item">
                                <span class="color-circle" style="border-color: {{ line.colour }};">
                                    <span>{{ line.line_no }}</span>
                                </span>
                                {{ line.line_name }}
                                <ul class="end-stations-list">
                                    {% for station in line.end_stations %}
                                        <li class="end-stations">{{ station.min_station_name }} - {{ station.max_station_name }}</li>
                                    {% endfor %}
                                </ul>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="panel middle-panel">
                <input type="text" id="search-station" placeholder="搜索车站">
                <ul id="station-list">
                    <!-- 默认情况下为空 -->
                </ul>
            </div>
            <div class="panel right-panel">
                <form id="path-form">
                    <label for="start-station" class="path-input-label">起点站</label>
                    <input type="text" id="start-station" placeholder="选择或输入起点站">
                    <br>
                    <label for="end-station" class="path-input-label">终点站</label>
                    <input type="text" id="end-station" placeholder="选择或输入终点站">
                    <br>
                    <button type="button" class="path-calculate-button">计算路线</button>
                    <div class="toggle-buttons">
                        <button type="button" class="toggle-btn active" data-mode="最短时间">最短时间</button>
                        <button type="button" class="toggle-btn" data-mode="最少换乘">最少换乘</button>
                    </div>
                    <div id="path-info">
                        <!-- 默认情况下为空 -->
                    </div>
                    <ul id="path-list">
                        <!-- 默认情况下为空 -->
                    </ul>
                </form>
            </div>
        </div>
    </main>

    <script>
        // 显示线路图
        document.querySelector('.line-map-button').addEventListener('click', function() {
            window.open('/line_map/', '_blank');
        });

        // 路径模式按钮切换
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButtons = document.querySelectorAll('.toggle-btn');

            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的 active 类
                    toggleButtons.forEach(btn => btn.classList.remove('active'));

                    // 给点击的按钮添加 active 类
                    this.classList.add('active');

                    // 如果输入了起终点站，发起对应调用
                    const startStationInput = document.getElementById('start-station');
                    const endStationInput = document.getElementById('end-station');

                    const startStationName = startStationInput.value.trim();
                    const endStationName = endStationInput.value.trim();

                    if (startStationName && endStationName) {
                        fetchAndShowPath(startStationName,endStationName,this.getAttribute('data-mode'))
                    }

                });
            });
        });

        // 文本过长时自动减少字体大小
        function adjustFontSize(element, maxCharCount, options = {}) {
            const defaultOptions = {
                minFontSize: 9, // 最小字体大小 (px)
            };

            const settings = { ...defaultOptions, ...options };
            let currentFontSize = parseFloat(window.getComputedStyle(element).fontSize);
            let textContent = element.textContent || element.innerText;
            let charCount = textContent.length;

            if (charCount > maxCharCount) {
                // 计算缩放比例
                let scale = maxCharCount / charCount;
                let newFontSize = currentFontSize * scale; // 固定缩小比例

                // 确保新字体大小不低于最小值
                if (newFontSize < settings.minFontSize) {
                    newFontSize = settings.minFontSize;
                }

                element.style.fontSize = `${newFontSize}px`;
            }
        }

        function adjustFontSizesInList(listElement, maxCharCount, options = {}) {
            const defaultOptions = {
                minFontSize: 9, // 最小字体大小 (px)
            };

            const settings = { ...defaultOptions, ...options };
            let minScale = 1; // 默认缩放比例为1，表示不缩放
            let elements = listElement.querySelectorAll('li');

            // 计算最小缩放比例
            elements.forEach(function(el) {
                let textContent = el.textContent || el.innerText;
                let charCount = textContent.length;

                if (charCount > maxCharCount) {
                    // 计算缩放比例
                    let scale = maxCharCount / charCount;
                    if (scale < minScale) {
                        minScale = scale;
                    }
                }
            });

            // 应用最小缩放比例到所有元素
            if (minScale <= 1) {
                let currentFontSize = parseFloat(window.getComputedStyle(elements[0]).fontSize);
                let newFontSize = currentFontSize * minScale;
                // 确保新字体大小不低于最小值
                if (newFontSize < settings.minFontSize) {
                    newFontSize = settings.minFontSize;
                }
                elements.forEach(function(el) {
                    el.style.fontSize = `${newFontSize}px`;
                });
            }

        }

        // 绘制车站列表
        function showStations(data, show_line_bar = false){
            const stationList = document.getElementById('station-list');
            // 路径查询的输入框
            const startStationInput = document.getElementById('start-station');
            const endStationInput = document.getElementById('end-station');

            // 获取第一个车站的第一个线路的颜色
            const firstStation = data.stations[0];
            const firstLineColor = firstStation.lines[0].colour;

            // 添加新的车站列表
            data.stations.forEach((station, stationIndex) => {
                const li = document.createElement('li');
                const a = document.createElement('a');

                // 包含车站所有信息的 div
                const stationItemDiv = document.createElement('div');
                stationItemDiv.style.display = 'flex'; // 使用 Flexbox 布局
                stationItemDiv.style.alignItems = 'center'; // 垂直居中对齐
                stationItemDiv.style.width = '100%'; // 占据整个父元素的宽度
                stationItemDiv.margin = 0; /* 去除默认的外边距 */
                stationItemDiv.padding = 0; /* 去除默认的内边距 */

                // 创建车站名称的 div
                const stationNameDiv = document.createElement('div');
                stationNameDiv.className = 'station-name';
                stationNameDiv.textContent = station.name;

                // 创建竖条
                const lineBarUp = document.createElement('div');
                lineBarUp.className = 'line-bar-up';
                lineBarUp.style.backgroundColor = firstLineColor
                const lineBarDown = document.createElement('div');
                lineBarDown.className = 'line-bar-down';
                lineBarDown.style.backgroundColor = firstLineColor

                // 创建线路编号和设施图标的 div
                const iconsDiv = document.createElement('div');
                iconsDiv.className = 'station-icons';
                iconsDiv.style.display = 'flex'; // 使用 Flexbox 布局
                iconsDiv.style.alignItems = 'center'; // 垂直居中对齐
                iconsDiv.style.gap = '1px'; // 图标之间的间距

                station.lines.forEach((line, lineIndex) => {
                    // 为每个线路创建容器
                    const lineIcon = document.createElement('span');
                    lineIcon.style.position = 'relative';

                    // 线路标识
                    const lineCircle = document.createElement('span');
                    lineCircle.className = 'color-circle';
                    lineCircle.style.borderColor = line.colour;
                    const lineNoSpan = document.createElement('span');
                    lineNoSpan.textContent = line.line_no;
                    lineCircle.appendChild(lineNoSpan);
                    lineIcon.appendChild(lineCircle);

                    // 线路竖条
                    if (lineIndex === 0 && show_line_bar) {
                        if (stationIndex === 0) {
                            // 第一站只有 down 竖条
                            lineIcon.appendChild(lineBarDown);
                        } else if (stationIndex === data.stations.length - 1) {
                            // 最后一站只有 up 端竖条
                            lineIcon.appendChild(lineBarUp);
                        } else {
                            lineIcon.appendChild(lineBarUp);
                            lineIcon.appendChild(lineBarDown);
                        }
                    }
                    iconsDiv.appendChild(lineIcon);
                });

                station.facilities.forEach(facility => {
                    if (facility.icon_image_data) {
                        const facilityIcon = document.createElement('img');
                        facilityIcon.src = `data:image/png;base64,${facility.icon_image_data}`; // 设置Base64编码的图片数据
                        facilityIcon.alt = `${facility.facility_type} icon`;
                        facilityIcon.style.marginTop = '5px'; // 对齐水平线
                        facilityIcon.style.marginRight = '-4px'; // 缩短设施图标的间距
                        facilityIcon.style.transform = 'scale(0.7)';
                        facilityIcon.style.transformOrigin = 'top left'; // 缩放的起始点设为左上角
                        iconsDiv.appendChild(facilityIcon);
                    }
                });

                // 创建首班车数据的div
                const firstTrainDiv = document.createElement('div');
                firstTrainDiv.className = 'first-train';

                const firstTrainLabelDiv = document.createElement('div');
                firstTrainLabelDiv.className = 'train-label';
                firstTrainLabelDiv.textContent = '首班车';

                const firstTrainDirectionDiv = document.createElement('div');
                firstTrainDirectionDiv.className = 'train-direction';
                const firstTrainTimeDiv = document.createElement('div');
                firstTrainTimeDiv.className = 'train-time';

                station.first_trains.forEach(train => {
                    const directionElement = document.createElement('div');
                    directionElement.className = 'train-direction-data';
                    directionElement.textContent = train.direction;

                    const timeElement = document.createElement('div');
                    timeElement.className = 'train-time-data';
                    timeElement.textContent = train.departure_time;

                    firstTrainDirectionDiv.appendChild(directionElement);
                    firstTrainTimeDiv.appendChild(timeElement);
                });

                firstTrainDiv.appendChild(firstTrainLabelDiv)
                firstTrainDiv.appendChild(firstTrainDirectionDiv);
                firstTrainDiv.appendChild(firstTrainTimeDiv);

                // 创建末班车数据的div
                const lastTrainDiv = document.createElement('div');
                lastTrainDiv.className = 'last-train';

                const lastTrainLabelDiv = document.createElement('div');
                lastTrainLabelDiv.className = 'train-label';
                lastTrainLabelDiv.textContent = '末班车';

                const lastTrainDirectionDiv = document.createElement('div');
                lastTrainDirectionDiv.className = 'train-direction';
                const lastTrainTimeDiv = document.createElement('div');
                lastTrainTimeDiv.className = 'train-time';

                station.last_trains.forEach(train => {
                    const directionElement = document.createElement('div');
                    directionElement.className = 'train-direction-data';
                    directionElement.textContent = train.direction;

                    const timeElement = document.createElement('div');
                    timeElement.className = 'train-time-data';
                    timeElement.textContent = train.departure_time;

                    lastTrainDirectionDiv.appendChild(directionElement);
                    lastTrainTimeDiv.appendChild(timeElement);
                });

                lastTrainDiv.appendChild(lastTrainLabelDiv)
                lastTrainDiv.appendChild(lastTrainDirectionDiv);
                lastTrainDiv.appendChild(lastTrainTimeDiv);

                // 创建跳转按钮
                const station_options_button = document.createElement('button');
                station_options_button.className = 'station-options-button';
                station_options_button.textContent = '>';

                // 添加点击事件监听器给跳转按钮
                station_options_button.addEventListener('click', function(event) {
                    event.preventDefault(); // 阻止默认行为

                    // 创建临时子列表
                    const optionsPopup = document.createElement('ul');
                    optionsPopup.className = 'station-options-popup';
                    // 设置临时子列表的位置并添加到 DOM
                    const rect = station_options_button.getBoundingClientRect();// 获取按钮的位置信息
                    optionsPopup.style.position = 'absolute';
                    optionsPopup.style.top = `${window.scrollY + rect.bottom}px`; // 放置在按钮下方，考虑页面滚动
                    optionsPopup.style.left = `${window.scrollX + rect.left}px`;  // 与按钮左边对齐，考虑页面滚动
                    document.body.appendChild(optionsPopup);

                    // 创建选项并添加到临时子列表
                    ['填入起点', '填入终点','车站信息'].forEach(optionText => {
                        const optionItem = document.createElement('li');
                        optionItem.textContent = optionText;

                        optionsPopup.appendChild(optionItem);

                        // 检测子列表项被按下
                        optionItem.addEventListener('click', () => {
                            if (optionText === '填入起点') {
                                startStationInput.value = station.name;
                            } else if (optionText === '填入终点') {
                                endStationInput.value = station.name;
                            }
                             else if (optionText === '车站信息') {
                                // 构造车站信息的 URL
                                const url = `/station/${encodeURIComponent(station.name)}/`;
                                window.open(url, "_blank");
                            }

                            // 移除临时子列表
                            optionsPopup.remove();
                        });

                    });

                    // 点击子列表外部关闭临时子列表
                    let closeOptionsPopupListener = null;
                    setTimeout(() => {
                        closeOptionsPopupListener = function(e) {
                            // 如果点击的目标不是子列表本身也不是其任何子元素，则关闭子列表
                            if (!optionsPopup.contains(e.target)) {
                                removeOptionsPopup();
                            }
                        };
                        document.addEventListener('click', closeOptionsPopupListener);
                    }, 1); // 延迟1ms避免过早关闭

                    function removeOptionsPopup() {
                        if (optionsPopup && document.body.contains(optionsPopup)) {
                            optionsPopup.remove();
                            if (closeOptionsPopupListener) {
                                document.removeEventListener('click', closeOptionsPopupListener);
                                closeOptionsPopupListener = null;
                            }
                        }
                    }
                });

                // 将各项添加到 stationItemDiv 中
                stationItemDiv.appendChild(stationNameDiv);
                stationItemDiv.appendChild(iconsDiv);
                stationItemDiv.appendChild(firstTrainDiv);
                stationItemDiv.appendChild(lastTrainDiv);
                stationItemDiv.appendChild(station_options_button);

                // 将 stationItemDiv 添加到 a 标签中
                a.appendChild(stationItemDiv);

                // 将 a 标签添加到 li 中
                li.appendChild(a);
                stationList.appendChild(li);

                requestAnimationFrame(() => {
                    // 计算行高并在 DOM 加载完成后更新竖条高度
                    const lineHeight = stationItemDiv.offsetHeight;
                    lineBarUp.style.height = `${lineHeight}px`;
                    lineBarDown.style.height = `${lineHeight}px`;
                    // 调整站名文本长度
                    adjustFontSize(stationNameDiv, 7);
                });
            });
        }

        // 调用车站列表
        function fetchAndShowStations(lineNoStr) {
            fetch(`/get_stations_for_line/${lineNoStr}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.stations) {
                        showStations(data, true);
                    } else {
                        console.error('No stations found for the line.');
                    }
                })
                .catch(error => console.error('Error fetching stations:', error));
        }

        // 搜索车站
        document.getElementById('search-station').addEventListener('input', function(event) {
            const search_text = event.target.value.trim();
            if (search_text.length > 0) {
                fetch(`/get_stations_for_search/?search_text=${encodeURIComponent(search_text)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.stations) {
                            // 清空现有的车站列表
                            const stationList = document.getElementById('station-list');
                            stationList.innerHTML = '';

                            showStations(data);
                        } else if (data.error) {
                            console.error('Error:', data.error);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                // 如果输入为空，则清空结果
                document.getElementById('station-results').innerHTML = '';
            }
        });

        // 点击线路项更新车站列表
        document.addEventListener('DOMContentLoaded', function() {
            const lineList = document.getElementById('line-list');

            // 获取线路列表中的第一条线路
            const firstLineLink = lineList.querySelector('a[data-line-no]');
            const firstLineNoStr = firstLineLink ? firstLineLink.getAttribute('data-line-no') : null;

            // 页面加载时显示第一条线路的车站列表
            if (firstLineNoStr) {
                fetchAndShowStations(firstLineNoStr);
            }

            // 点击线路列表项时更新车站列表
            lineList.addEventListener('click', function(event) {
                // 清空现有的车站列表
                const stationList = document.getElementById('station-list');
                stationList.innerHTML = '';

                event.preventDefault();
                const link = event.target.closest('a');
                if (link) {
                    const lineNoStr = link.getAttribute('data-line-no'); // getAttribute返回的是字符串类型

                    if (lineNoStr === "3") { // 3号线显示3北
                        fetchAndShowStations('3.5');
                    }
                    else if (lineNoStr === "14") { // 14号线显示14支
                        fetchAndShowStations('14.5');
                    }

                    fetchAndShowStations(lineNoStr);
                }
            });


        });

        // 调用路径查询
        function fetchAndShowPath(startStationName,endStationName,search_type) {
            // 构建URL
            const url = `/calculate_path/${encodeURIComponent(startStationName)}/${encodeURIComponent(endStationName)}/${search_type}/`;
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => showPaths(data))
            .catch(error => {
                console.error('Error:', error);
                alert(`发生错误: ${error.error || '未知错误'}`);
            });
        }

        // 计算路径
        document.querySelector('.path-calculate-button').addEventListener('click', function() {
            const startStationInput = document.getElementById('start-station');
            const endStationInput = document.getElementById('end-station');

            const startStationName = startStationInput.value.trim();
            const endStationName = endStationInput.value.trim();
            if (!startStationName || !endStationName) {
                alert('起点站或终点站为空');
            }

            // 获取搜索模式按钮的激活状态
            const activeButton = document.querySelector('.toggle-btn.active');
            if (!activeButton) {
                alert('请选择路径模式');
                return;
            }
            const search_type = activeButton.getAttribute('data-mode');

            fetchAndShowPath(startStationName,endStationName,search_type)
        });

        // 绘制路径信息
        function showPaths(data) {
            const pathInfoDiv = document.getElementById('path-info');
            pathInfoDiv.className = 'path-info';
            const pathList = document.getElementById('path-list');

            // 清空现有内容
            pathInfoDiv.innerHTML = '';
            pathList.innerHTML = '';

            // 显示总时间、车站数、换乘数
            const totalTimeDiv = document.createElement('div');
            totalTimeDiv.className = 'path-info-item';
            createTwoLineContent(totalTimeDiv, '总时间', `约 ${data.total_time} 分钟`);
            pathInfoDiv.appendChild(totalTimeDiv);

            const stationCountDiv = document.createElement('div');
            stationCountDiv.className = 'path-info-item';
            createTwoLineContent(stationCountDiv, '车站数', data.station_count);
            pathInfoDiv.appendChild(stationCountDiv);

            const transferCountDiv = document.createElement('div');
            transferCountDiv.className = 'path-info-item';
            createTwoLineContent(transferCountDiv, '换乘数', data.transfer_count);
            pathInfoDiv.appendChild(transferCountDiv);

            // 辅助函数来创建两行文本的内容
            function createTwoLineContent(parentDiv, title, content) {
                const titleElement = document.createElement('div');
                titleElement.className = 'path-info-title';
                titleElement.textContent = title;
                parentDiv.appendChild(titleElement);

                const contentElement = document.createElement('div');
                contentElement.className = 'path-info-content';
                contentElement.textContent = content;
                parentDiv.appendChild(contentElement);
            }

            // 显示路径详情
            data.path.forEach(item => {
                const li = document.createElement('li');
                const a = document.createElement('a');

                // 创建包含路径所有信息的 div
                const pathItemDiv = document.createElement('div');
                pathItemDiv.style.display = 'flex';
                pathItemDiv.style.alignItems = 'center';
                pathItemDiv.style.width = '100%';
                pathItemDiv.style.margin = '0';
                pathItemDiv.style.padding = '0';

                // 增加行高
                if (item.line_no === "站数" || item.line_no === "换乘"){
                    pathItemDiv.style.lineHeight = '2em';
                }

                // 创建竖条
                const lineBarUp = document.createElement('div');
                lineBarUp.className = 'line-bar-up';
                lineBarUp.style.backgroundColor = item.colour;

                const lineBarDown = document.createElement('div');
                lineBarDown.className = 'line-bar-down';
                lineBarDown.style.backgroundColor = item.colour;

                // 创建线路编号和设施图标的 div
                const iconsDiv = document.createElement('div');
                iconsDiv.className = 'station-icons';
                iconsDiv.style.display = 'flex';
                iconsDiv.style.alignItems = 'center';
                iconsDiv.style.gap = '1px';

                // 线路标识
                const lineIcon = document.createElement('span');
                lineIcon.style.position = 'relative';

                if (item.line_no !== "站数" && item.line_no !== "换乘") {
                    const lineCircle = document.createElement('span');
                    lineCircle.className = 'color-circle';
                    lineCircle.style.borderColor = item.colour;
                    const lineNoSpan = document.createElement('span');
                    lineNoSpan.textContent = item.line_no;
                    lineCircle.appendChild(lineNoSpan);
                    lineIcon.appendChild(lineCircle);
                }
                else{
                    // 创建一个透明 div 用于定位
                    const lineCircle = document.createElement('span');
                    lineCircle.className = 'color-circle';
                    lineCircle.style.borderColor = 'transparent';
                    lineCircle.style.backgroundColor = 'transparent';
                    lineIcon.appendChild(lineCircle);
                }

                // 根据条件添加竖条
                if (item.line_no === "站数"){
                    lineIcon.appendChild(lineBarUp);
                    lineIcon.appendChild(lineBarDown);
                }


                iconsDiv.appendChild(lineIcon);

                // 创建文本的 div
                const pathTextDiv = document.createElement('div');
                pathTextDiv.textContent = item.text;

                // 将各项添加到 pathItemDiv 中
                pathItemDiv.appendChild(iconsDiv);
                pathItemDiv.appendChild(pathTextDiv);

                // 将 pathItemDiv 添加到 a 标签中
                a.appendChild(pathItemDiv);

                // 将 a 标签添加到 li 中
                li.appendChild(a);
                pathList.appendChild(li);

                requestAnimationFrame(() => {
                    // 计算行高并在 DOM 加载完成后更新竖条高度
                    const lineHeight = pathItemDiv.offsetHeight*1.1;
                    lineBarUp.style.height = `${lineHeight}px`;
                    lineBarDown.style.height = `${lineHeight}px`;

                    // 调整文本最大长度
                    if (item.line_no !== "站数" && item.line_no !== "换乘") {
                        adjustFontSize(pathTextDiv, 12,{minFontSize: 12});
                    }
                    else{
                        pathTextDiv.style.fontSize = '0.85em';// 站数与换乘的文本缩小
                        adjustFontSize(pathTextDiv, 14,{minFontSize: 11});
                    }
                });
            });
        }

        // 在DOM加载完后检测文本过长
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.end-stations-list').forEach(function(listEl) {
                adjustFontSizesInList(listEl, 13,{minFontSize: 9});
            });
        });
    </script>
</body>
</html>